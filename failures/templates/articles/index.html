<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Failures Database</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Failures Database">
  <meta name="author" content="Purdue University ECE Duality Lab">

  <!-- Third-party CSS libraries -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css"
        integrity="sha512-GQGU0fMMi238uA+a/bdWJfpUGKUkBdgfFdgBm72SUQ6BeyWjoY/ton0tEjH+OSH9iP4Dfh+7HM0I9f5eR0L/4w=="
        crossorigin="anonymous" referrerpolicy="no-referrer"/>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Project-specific CSS -->

  <style>
    .hover-card {
      cursor: pointer;
    }

    .alert-fixed {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 9999;
      border-radius: 0;
    }
  </style>

  <!-- Third-party Javascript libraries -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.min.js"
          integrity="sha512-OvBgP9A2JBgiRad/mM36mkzXSXaJE9BEIENnVEmeZdITvwT09xnxLtT4twkCa8m/loMbPHsvPl0T8lRGVBwjlQ=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js"
          integrity="sha384-GNFwBvfVxBkLMJpYMOABq3c+d3KnQxudP/mGPkzpZSTYykLBNsZEnG2D9G/X/+7D" crossorigin="anonymous"
          async></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.1/dist/jquery.min.js"
          integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
  <!-- Project-specific Javascript -->

</head>
<body>

<div class="col-lg-10 col-12 offset-lg-1 shadow-lg bg-body rounded h-100 overflow-scroll">
  <!-- Navbar and Nav Search -->
  <nav class="navbar navbar-expand-lg navbar-dark py-2 bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand fs-3" href="#">
        <img
          src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/35/Purdue_Boilermakers_logo.svg/1200px-Purdue_Boilermakers_logo.svg.png"
          alt="Purdue Logo" width="80" height="55"
          class="d-inline-block align-text-middle">
        Failures Database
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
              data-bs-target="#navbar-content" aria-controls="navbar-content"
              aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
    </div>
  </nav>

  <ul class="nav nav-tabs nav-fill mt-3" id="sisyphus-tab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link text-dark" id="objects-tab" data-bs-toggle="tab" data-bs-target="#objects"
              type="button"
              role="tab" aria-controls="objects" aria-selected="true">
        <i class="bi bi-database"></i>
        <b>Failures</b>
      </button>
    </li>

    <li class="nav-item" role="presentation">
      <button class="nav-link text-dark active" id="annotations-tab" data-bs-toggle="tab" data-bs-target="#annotations"
              type="button"
              role="tab" aria-controls="annotations" aria-selected="true">
        <i class="bi bi-magic"></i>
        <b>Generate</b>
      </button>
    </li>

    <li class="nav-item" role="presentation">
      <button class="nav-link text-dark" id="settings-tab" onclick="window.location.href = '/admin';"
              type="button" role="tab" aria-controls="settings" aria-selected="false">
        <i class="bi bi-clipboard2-data"></i>
        <b>Admin</b>
      </button>
    </li>
  </ul>

  <div class="tab-content" id="sisyphus-tab-content">
    <div class="tab-pane fade show active" id="objects" role="tabpanel" aria-labelledby="objects-tab">
      <div class="col-11 mx-auto my-4">
        <div data-masonry='{"percentPosition": true }' class="row">
          <div class="col-12 col-lg-6 mx-auto mb-3">
            <div class="card shadow">
              <div class="card-header pb-0 bg-body border-0">
                <h6 class="mb-0 mt-2 d-flex align-items-center fs-6">
                  Article Inspection
                </h6>
                <div class="card m-3 rounded shadow-sm" id="blockerDiv">
                  <div class="card-body bg-light p-5">
                    <h5 class="text-center p-5 text-secondary">
                      Run a Search Query to Scrape Articles
                      <br>
                    </h5>
                  </div>
                </div>

              </div>
              <div class="card-body">

              </div>
            </div>
          </div>
          <div class="col-12 col-lg-6 mx-auto mb-3">
            <div class="card shadow">
              <div class="card-header rounded">
                <h6 class="mt-2">
                  <i class="bi bi-dpad"></i>
                  Actions
                </h6>
              </div>
              <div class="card-body rounded pt-0">
                <div class="card my-3 rounded shadow-sm hover-card"
                     onclick="$('#select-queries-modal').modal('show');">
                  <div class="card-body">
                    <div class="row h-100">
                      <div class="col align-self-end">
                        <h6 class="card-title">RUN SEARCH QUERIES</h6>
                        <p class="card-text">Create, Select, and Run Search Queries</p>
                      </div>
                      <div class="col-auto pl-0 d-flex align-items-center">
                        <i class="material-icons card-icon ml-1" id="checkButton">search</i>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="card my-3 rounded shadow-sm hover-card"
                     onclick="$('#select-stores-modal').modal('show');">
                  <div class="card-body">
                    <div class="row h-100">
                      <div class="col align-self-end">
                        <h6 class="card-title">GENERATE SUMMARIES</h6>
                        <p class="card-text">Generate Summaries for the Selected Articles</p>
                      </div>
                      <div class="col-auto pl-0 d-flex align-items-center">
                        <i class="material-icons card-icon ml-1" id="checkButton">format_list_bulleted</i>
                        <div class="spinner-border d-none" role="status" id="spinner">
                        </div>
                        <div class="d-none" id="prediction">
                          You Shouldn't See This
                        </div>
                      </div>

                    </div>
                  </div>
                </div>
                <div class="card my-3 rounded shadow-sm hover-card"
                     onclick="$('#select-stores-modal').modal('show');">
                  <div class="card-body">
                    <div class="row h-100">
                      <div class="col align-self-end">
                        <h6 class="card-title">CLASSIFY FAILURE ARTICLES</h6>
                        <p class="card-text">Classify the Selected Articles as Software Failures</p>
                      </div>
                      <div class="col-auto pl-0 d-flex align-items-center">
                        <i class="material-icons card-icon ml-1" id="checkButton">precision_manufacturing</i>
                        <div class="spinner-border d-none" role="status" id="spinner">
                        </div>
                        <div class="d-none" id="prediction">
                          You Shouldn't See This
                        </div>
                      </div>

                    </div>
                  </div>
                </div>
                <div class="card my-3 rounded shadow-sm hover-card"
                     onclick="$('#select-stores-modal').modal('show');">
                  <div class="card-body">
                    <div class="row h-100">
                      <div class="col align-self-end">
                        <h6 class="card-title">MERGE ARTICLES INTO FAILURE STORIES</h6>
                        <p class="card-text">Merge the Selected Articles into Software Failure Stories</p>
                      </div>
                      <div class="col-auto pl-0 d-flex align-items-center">
                        <i class="material-icons card-icon ml-1" id="checkButton">merge</i>
                        <div class="spinner-border d-none" role="status" id="spinner">
                        </div>
                        <div class="d-none" id="prediction">
                          You Shouldn't See This
                        </div>
                      </div>

                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-6 mx-auto mb-3">
            <div class="card shadow h-100">
              <div class="card-header rounded">
                <h6 class="mt-2">
                  <i class="bi bi-book"></i>
                  Failure Stories
                </h6>
              </div>
              <div id="annotationsList" class="card-body rounded overflow-scroll"
                   style="max-height: 345px;">
                <div class="card mb-3 rounded shadow-sm generic-receipt d-none">
                  <div class="card-body">
                    <div class="row h-100">
                      <div class="col align-self-end">
                        <h6 class="card-title">Motion</h6>
                        <p class="card-text">Timestamp</p>
                      </div>
                      <div class="col-auto pl-0 d-flex align-items-center">
                        <i name="" class="material-icons card-icon ml-1 delete-annotation"
                           style="color: #e00c0c; cursor: pointer;">
                          delete_forever
                        </i>
                      </div>
                    </div>
                  </div>
                </div>
                {% for annotation in annotations %}
                  <div class="card mb-3 rounded shadow-sm">
                    <div class="card-body">
                      <div class="row h-100">
                        <div class="col align-self-end">
                          <h6 class="card-title">Annotation #{{ annotation.id }}
                            - {{ annotation.get_motion_display }}</h6>
                          <p class="card-text">{{ annotation.created_at }}</p>
                        </div>
                        <div class="col-auto pl-0 d-flex align-items-center">
                          <i name="{{ annotation.id }}"
                             class="material-icons card-icon ml-1 delete-annotation"
                             style="color: #e00c0c; cursor: pointer;">
                            delete_forever
                          </i>
                        </div>
                      </div>
                    </div>
                  </div>
                {% empty %}
                  <div class="card m-3 rounded shadow-sm" id="noAnnotations">
                    <div class="card-body bg-light p-5">
                      <h5 class="text-center p-5 text-secondary">
                        Start Generating to See New Stories
                      </h5>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-6 mx-auto mb-3">
            <div class="card shadow">
              <div class="card-header pb-0 bg-body border-0">
                <h6 class="mb-0 mt-2 d-flex align-items-center fs-6">
                  Failure Classifier Metrics Graph
                </h6>
              </div>
              <div class="card m-3 rounded shadow-sm" id="blockerDiv">
                <div class="card-body bg-light p-5">
                  <h5 class="text-center p-5 text-secondary">
                    Annotate More to See Classifier Metrics
                    <br>
                  </h5>
                </div>
              </div>

              <div class="card-body d-none" id="networkDiv">
                <canvas id="network-metrics-chart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <form method="post" id="searchQueryForm">
    {% csrf_token %}
    <div class="modal fade" id="select-queries-modal" tabindex="-1" aria-labelledby="select-queries-modal-label"
         aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content border-0">
          <div class="modal-header bg-dark">
            <h5 class="modal-title text-white" id="select-stores-modal-label">Select Search Queries</h5>
            <button type="button" class="close btn btn-sm btn-modal-close"
                    data-bs-dismiss="modal" aria-label="Close">
              <i class="bi bi-x text-white"></i>
            </button>
          </div>
          <div class="modal-body">
            <div id="annotationsList" class="card-body rounded overflow-scroll"
                 style="max-height: 345px; overflow-x: hidden!important;">
              <div class="card mb-3 rounded shadow-sm generic-receipt">
                <div class="card-body">
                  <div class="row h-100">
                    <div class="col align-self-end">
                      <p class="card-text mb-1"><b>Keyword:</b> software failure</p>
                      <p class="card-text mb-1"><b>Sources:</b> nytimes.com, wired.com, techcrunch.com</p>
                      <p class="card-text mb-1"><b>Start Year:</b> 2000</p>
                      <p class="card-text mb-0"><b>End Year:</b> 2022</p>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card mb-3 rounded shadow-sm generic-receipt">
                <div class="card-body">
                  <div class="row h-100">
                    <div class="col align-self-end">
                      <p class="card-text mb-1"><b>Keyword:</b> software failure</p>
                      <p class="card-text mb-1"><b>Sources:</b> nytimes.com, wired.com, techcrunch.com</p>
                      <p class="card-text mb-1"><b>Start Year:</b> 2000</p>
                      <p class="card-text mb-0"><b>End Year:</b> 2022</p>
                    </div>
                  </div>
                </div>
              </div>

              <div class="card mb-3 rounded shadow-sm generic-receipt hover-card">
                <div class="card-body">
                  <div class="row h-100">
                    <div class="col align-self-end">
                      <p class="card-text mb-1"><b>Keyword:</b> software failure</p>
                      <p class="card-text mb-1"><b>Sources:</b> nytimes.com, wired.com, techcrunch.com</p>
                      <p class="card-text mb-1"><b>Start Year:</b> 2000</p>
                      <p class="card-text mb-0"><b>End Year:</b> 2022</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <p class="mt-3">
              Select the search queries to run. Search queries are defined by a keyword, a list of sources, a start year, and an end year.
            </p>
            <p class="mb-0 fs-7">
              <i class="bi bi-question-circle"></i>
              <span>
              Is this information helpful?
              <a class="small-link mx-1" href="#">Yes</a>
              <a class="small-link mx-1" href="#">No</a>
            </span>
            </p>
          </div>
          <div class="modal-footer">
            <button class="btn bg-dark text-white btn-modal-close" data-bs-dismiss="modal">
              Run
            </button>
          </div>
        </div>
      </div>
    </div>
  </form>

  <!-- Alerts -->
  <!-- TODO: Fix repop of alert -->
  <div id="connection-success-alert" class="alert alert-success alert-fixed alert-dismissible"
       role="alert">
    Connected Successfully!
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  <div id="annotation-success-alert" class="alert alert-success alert-fixed alert-dismissible"
       role="alert">
    Annotation Submitted Successfully!
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  <div id="annotation-deleted-alert" class="alert alert-success alert-fixed alert-dismissible"
       role="alert">
    Annotation Deleted Successfully!
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  <div id="server-error-alert" class="alert alert-danger alert-fixed alert-dismissible"
       role="alert">
    Server Error! Please Refresh the Page.
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>


</div>

<script>
  $("#connection-success-alert").hide();
  $("#annotation-success-alert").hide();
  $("#server-error-alert").hide();
  $("#annotation-deleted-alert").hide();

  function showAlert(alertId) {
    $(alertId).fadeTo(2000, 500).slideUp(500, function () {
      $(alertId).slideUp(500);
    });
  }

  let annotationsCount = {{ annotations|length }};
  let timeStep = 0;
  let timeStepInterval = 125;
  let imuDataOnDeck = [];

  function magnitude_g(json) {
    return Math.sqrt(
      Math.pow(json.gyro_x, 2) +
      Math.pow(json.gyro_y, 2) +
      Math.pow(json.gyro_z, 2)
    );
  }

  function magnitude_a(json) {
    return Math.sqrt(
      Math.pow(json.accel_x, 2) +
      Math.pow(json.accel_y, 2) +
      Math.pow(json.accel_z, 2)
    );
  }

  $("#annotationForm").submit(function (e) {
    e.preventDefault();
    let annotation = $("input[name='udlr-radio']:checked").val();
    console.log(annotation);
    let annotation_dict = {
      "tag": "annotation",
      "motion": annotation,
      "imu_data": imuDataOnDeck
    };
    socket.send(JSON.stringify(annotation_dict));
    showAlert("#annotation-success-alert");
    annotationsCount++;
  });

  let socket = null;

  $("#connection-search").on("submit", function (e) {
    e.preventDefault();

    socket = new WebSocket(
      'ws://' + window.location.host +
      '/ws/annotations/'
    );

    socket.onmessage = function (e) {
      const data = JSON.parse(e.data);
      if (data["tag"] === "prediction_response") {
        $("#spinner").addClass("d-none");
        let predictionElement = $("#prediction");
        predictionElement.html("Network Prediction: <b>" + data["motion"] + "</b> with <b>" + data["confidence"] + "%</b> Confidence");
        predictionElement.removeClass("d-none");
      }

      if (data['tag'] === 'receipt') {
        console.log(data);
        // get element with id noAnnotations and hide it
        $("#noAnnotations").hide();
        // get the element with class generic-receipt, clone it, and append it to the div with id annotationsList
        let receipt = $(".generic-receipt").clone();
        receipt.removeClass("generic-receipt");
        receipt.removeClass("d-none");
        receipt.find(".card-title").text("Annotation #" + data['id'] + " - " + data['motion']);
        receipt.find(".card-text").text(data['created_at']);
        receipt.find(".delete-annotation").attr("name", data['id']);
        // add listener to delete button
        $("#annotationsList").prepend(receipt);
        addDeleteListener();
        // check if data has accuracy key
        if (data.hasOwnProperty('accuracy')) {
          console.log("Accuracy: " + data['accuracy']);
          $("#blockerDiv").hide();
          $("#networkDiv").removeClass("d-none");
          addData(networkMetricsChart, data["annotation_count"], data["accuracy"]);
          networkMetricsChart.update("none");
        }
        return;
      }

      if (data["tag"] === "lots_imu_data") {
        console.log(data)
        clearChart(magnitudeChart);
        $("#checkButton").css({"color": "black"});
        imuDataOnDeck = [];
        for (let i = 0; i < data["imu_data"].length; i++) {
          imuDataOnDeck.push(data["imu_data"][i]);
          if (data["imu_data"][i]["button"]) {
            // set element with id checkButton to color red
            $("#checkButton").css({"color": "#FF0000"});
          }
          addData(magnitudeChart, timeStep, magnitude_a(data["imu_data"][i]), 0);
          addData(magnitudeChart, timeStep, magnitude_g(data["imu_data"][i]), 1);
          timeStep++;
        }
        magnitudeChart.update("none");
        timeStep = 0;
        $("#prediction").addClass("d-none");
        $("#spinner").removeClass("d-none");
        socket.send(JSON.stringify({
          "tag": "prediction_request",
          "imu_data": imuDataOnDeck
        }));
      }
    };

    socket.onclose = function (e) {
      console.error('Socket closed unexpectedly');
      showAlert("#server-error-alert");
    };

    document.getElementById("selected-connection").text = $("#connection-select option:selected").text();

    showAlert("#connection-success-alert");

  });

  // add on click event for recordButton element
  $("#recordButton").click(function () {
    // send record message to server
    socket.send(JSON.stringify({
      "tag": "record"
    }));
  });

  $(".hover-card").hover(
    function () {
      $(this)[0].classList.replace("shadow-sm", "shadow");
    }, function () {
      $(this)[0].classList.replace("shadow", "shadow-sm");
    }
  );

  function addDeleteListener() {
    $(".delete-annotation").click(function () {
      // make ajax request using this elements name as the id
      let trashIcon = $(this);
      $.ajax({
        url: "/annotations/" + trashIcon.attr("name"),
        // include csrf token in header
        headers: {"X-CSRFToken": "{{ csrf_token }}"},
        type: "DELETE",
        success: function (result) {
          // remove the parent with class card by finding the closest parent with class card
          trashIcon.closest(".card").remove();
          showAlert("#annotation-deleted-alert");
          annotationsCount--;
        }
      });
    });
  }

  // on page load, add delete listener to all delete buttons
  addDeleteListener();

  const magnitudeData = {
    datasets: [{
      backgroundColor: 'rgb(255, 99, 132)',
      borderColor: 'rgb(255, 99, 132)',
      label: "Acceleration Magnitude",
      yAxisID: 'y',
    },
      {
        backgroundColor: 'rgb(54, 162, 235)',
        borderColor: 'rgb(54, 162, 235)',
        label: "Gyro Magnitude",
        yAxisID: 'y1',
      }
    ]
  };

  const networkData = {
    datasets: [{
      backgroundColor: 'rgb(255, 99, 132)',
      borderColor: 'rgb(255, 99, 132)',
      label: "Validation Accuracy"
    }]
  };

  const magnitude_config = {
    type: 'line',
    data: magnitudeData,
    options: {
      scales: {
        x: {
          title: {
            display: true,
            text: 'Timestep'
          }
        },
        y: {
          title: {
            text: 'Acceleration Magnitude',
            display: true,
          },
          position: 'left',
        },
        y1: {
          title: {
            text: 'Gyro Magnitude',
            display: true,
          },
          position: 'right'
        }
      }
    }
  };
  const magnitudeChart = new Chart(
    document.getElementById('magnitude-chart'),
    magnitude_config
  );

  const network_metrics_config = {
    type: 'line',
    data: networkData,
    options: {
      scales: {
        x: {
          title: {
            display: true,
            text: 'Number of Annotations'
          }
        },
        y: {
          title: {
            text: 'Accuracy',
            display: true,
          }
        }
      }
    }
  };

  const networkMetricsChart = new Chart(
    document.getElementById('network-metrics-chart'),
    network_metrics_config
  );


  function addData(chart, label, data, i = 0) {
    if (i === 0) {
      chart.data.labels.push(label);
    }
    chart.data.datasets[i].data.push(data);
  }

  function clearChart(chart) {
    chart.data.labels = [];
    chart.data.datasets.forEach((dataset) => {
      dataset.data = [];
    });
    chart.update("none");
  }

</script>

</body>
